Sub Alta2()

'Application.ScreenUpdating = False
'Application.Calculation = xlCalculationManual
Application.EnableEvents = False

Call DefVariables

nLP = 1
nLV = 1

If Not FileInUse(Path & Listados) Then Workbooks.Open (Path & Listados)

    u = Workbooks(Listados).Sheets(Actuales).Range("A2").End(xlDown).Row
    
    Dim LP()
    Dim LV()

    For n0 = 2 To u
        xTd = Workbooks(Listados).Sheets(Actuales).Cells(n0, 2).Value
        xLP = Workbooks(Listados).Sheets(Actuales).Cells(n0, 3).Value
        
        If xLP = "x" Then
            ReDim Preserve LP(1 To nLP)
            LP(nLP) = Workbooks(Listados).Sheets(Actuales).Cells(n0, 1).Value
            nLP = nLP + 1
        ElseIf xTd = "x" Then
            ReDim Preserve LV(1 To nLV)
            LV(nLV) = Workbooks(Listados).Sheets(Actuales).Cells(n0, 1).Value
            nLV = nLV + 1
        End If
    
    Next n0

Workbooks(Listados).Close

    Dim Nom As Integer
    Dim Av As Integer
    Dim Ad As Integer
    Dim Dev As Integer
    Dim Mor As Integer
    Dim Desc As Integer
    Dim Red As Integer
    Dim Com As Integer
    
    Nom = 1
    Av = 2
    Ad = 3
    Dev = 4
    Mor = 5
    Desc = 6
    Red = 7
    Com = 9

Workbooks(Diario).Sheets(HDiario).Activate

    l = Workbooks(Diario).Sheets(HDiario).Range("B3").End(xlDown).Row + 1
    i = Application.WorksheetFunction.Max(Range("A2:A" & l))

    Cells(l, 1).Value = i + 1

Workbooks(Diario).Sheets(Tabla).Activate

    j = Range("A2").End(xlDown).Row
    Fecha = Sheets(Tabla).Range("K7").Value

    p = l
    
    For n1 = 7 To j

        If Sheets(Tabla).Cells(n1, Av).Value <> "" Then
            Call AltaAsiento(n1, Av, p, "Aviso", Com, Fecha, "D")
            p = p + 1
        End If

    Next n1

    For n2 = 7 To j

        If Sheets(Tabla).Cells(n2, Red).Value <> "" Then
            Call AltaAsiento(n2, Red, p, "Redes", Com, Fecha, "D")
            p = p + 1
        End If

    Next n2
        
    For n3 = 2 To 6
        If Sheets(Tabla).Cells(n3, 2).Value <> "" Then
            Sheets(HDiario).Cells(p, 4).Value = Cells(n3, 1).Value
            Sheets(HDiario).Cells(p, 7).Value = Cells(n3, 2).Value
            Sheets(HDiario).Cells(p, 10).Value = Cells(n3, Com).Value
            Sheets(HDiario).Cells(p, 2).Value = Fecha
            p = p + 1
        End If
    Next n3
    

    FactAv = Sheets(Tabla).Cells(j + 2, Av).Value
    FactRd = Sheets(Tabla).Cells(j + 2, Red).Value
    OtIng = Application.WorksheetFunction.Sum(Sheets(Tabla).Range("H2:H6"))
    
    Sheets(HDiario).Cells(p, 6).Value = "Facturación de Avisos"
    Sheets(HDiario).Cells(p, 8).Value = FactAv
    Sheets(HDiario).Cells(p, 2).Value = Fecha
    
    If FactRd <> vbEmpty Then
        Sheets(HDiario).Cells(p + 1, 6).Value = "Facturación Redes"
        Sheets(HDiario).Cells(p + 1, 8).Value = FactRd
        Sheets(HDiario).Cells(p + 1, 2).Value = Fecha
        g1 = p + 2
    Else
        g1 = p + 1
    End If

    
    If OtIng <> vbEmpty Then
        Sheets(HDiario).Cells(g1, 6).Value = "Otros ingresos operativos"
        Sheets(HDiario).Cells(g1, 8).Value = OtIng
        Sheets(HDiario).Cells(g1, 2).Value = Fecha
        p = g1 + 1
    Else
        p = g1
    End If

    Sheets(HDiario).Cells(p, 1).Value = i + 2
    
    Sheets(HDiario).Cells(p, 4).Value = "Facturación de Avisos"
    Sheets(HDiario).Cells(p, 7).Value = FactAv
    Sheets(HDiario).Cells(p, 2).Value = Fecha

    If FactRd <> vbEmpty Then
        Sheets(HDiario).Cells(p + 1, 4).Value = "Facturación Redes"
        Sheets(HDiario).Cells(p + 1, 7).Value = FactRd
        Sheets(HDiario).Cells(p + 1, 2).Value = Fecha
        g2 = p + 2
    Else
        g2 = p + 1
    End If

    If OtIng <> vbEmpty Then
        Sheets(HDiario).Cells(g2, 4).Value = "Otros ingresos operativos"
        Sheets(HDiario).Cells(g2, 7).Value = OtIng
        Sheets(HDiario).Cells(g2, 2).Value = Fecha
        ñ = g2 + 1
    Else
        ñ = g2
    End If

    Sheets(HDiario).Cells(ñ, 6).Value = "Ventas"
    Sheets(HDiario).Cells(ñ, 8).Value = FactAv + FactRd + OtIng
    Sheets(HDiario).Cells(ñ, 2).Value = Fecha

    p = ñ + 1

If Sheets(Tabla).Cells(j + 2, Desc).Value <> 0 Then
    
    Sheets(HDiario).Cells(p, 1).Value = i + 3

    For n = 7 To j
        If Sheets("Tabla").Cells(n, Desc).Value <> "" Then
            Call AltaAsiento(n, Desc, p, "Desc. otorgados", Com, Fecha, "D")
            p = p + 1
        End If
    Next n
    
    For nn = 7 To j
        If Sheets("Tabla").Cells(nn, Desc).Value <> "" Then
            Call AltaAsiento(nn, Desc, p, "Aviso", Com, Fecha, "H")
            p = p + 1
        End If
    Next nn

End If

Sheets(HDiario).Activate
Sheets(HDiario).Cells(p - 1, 8).Select

Application.ScreenUpdating = True
Application.Calculation = xlCalculationAutomatic
Application.EnableEvents = True

End Sub
Private Sub AltaAsiento(filafuente, colfuente, filaobj, texto, Com, Fecha, DoH)

If DoH = "D" Then
    col1 = 4
    col2 = 7
    col3 = 3
Else
    col1 = 6
    col2 = 8
    col3 = 5
End If

cta = texto & " " & Sheets("Tabla").Cells(filafuente, 1).Value

Sheets("Diario").Cells(filaobj, col1).Value = cta
Sheets("Diario").Cells(filaobj, col2).Value = Sheets("Tabla").Cells(filafuente, colfuente).Value
Sheets("Diario").Cells(filaobj, 10).Value = Sheets("Tabla").Cells(filafuente, Com).Value
Sheets("Diario").Cells(filaobj, 2).Value = Fecha
Sheets("Diario").Cells(filaobj, col3).Value = CodigoCuenta(cta)

End Sub
Private Function CodigoCuenta(cuenta)

Call DefVariables
Sheets(HDiario).Activate

c = Application.WorksheetFunction.VLookup(cuenta, Sheets(HDiario).Range("AA1:AB" & Range("AA1").End(xlDown).Row), 2, False)

Sheets(Tabla).Activate

CodigoCuenta = c

End Function
Sub ffghg()

Application.ScreenUpdating = True
Application.Calculation = xlCalculationAutomatic
Application.EnableEvents = True

End Sub
